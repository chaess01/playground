<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layouts/layout1}" class="itemDtl">

<head>
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link th:href="@{/css/itemDtl.css}" rel="stylesheet">
    <!-- Font Awesome 링크 추가 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  
</head>

<div layout:fragment="content">

    <input type="hidden" id="itemId" th:value="${item.id}">

    <div class="breadcrumb">
        <a href="/" class="breadcrumb-link">홈</a>
        <span class="breadcrumb-separator">›</span>
        <span class="breadcrumb-separator" th:text="${item.company}"></span>
        <span class="breadcrumb-separator">›</span>
        <span class="breadcrumb-separator" th:if="${item.itemCategoryDto.action}">액션</span>
        <span class="breadcrumb-separator"th:if="${item.itemCategoryDto.adventure}">모험</span>
        <span class="breadcrumb-separator"th:if="${item.itemCategoryDto.rpg}">RPG</span>
        <span class="breadcrumb-separator"th:if="${item.itemCategoryDto.shooter}">슈팅</span>
        <span class="breadcrumb-separator" th:if="${item.itemCategoryDto.strategy}">전략</span>
        <span class="breadcrumb-separator"th:if="${item.itemCategoryDto.simulation}">시뮬레이션</span>
        <span class="breadcrumb-separator"th:if="${item.itemCategoryDto.puzzle}">퍼즐</span>
        <span class="breadcrumb-separator"th:if="${item.itemCategoryDto.sports}">스포츠</span>
        <span class="breadcrumb-separator"th:if="${item.itemCategoryDto.racing}">레이싱</span>
        <span class="breadcrumb-separator"th:if="${item.itemCategoryDto.fighting}">격투</span>
        <span class="breadcrumb-separator"th:if="${item.itemCategoryDto.survival}">생존</span>
        <span class="breadcrumb-separator"th:if="${item.itemCategoryDto.rhythm}">리듬게임</span>
        <span class="breadcrumb-separator"th:if="${item.itemCategoryDto.sandbox}">샌드박스</span>
        <span class="breadcrumb-separator"th:if="${item.itemCategoryDto.battleRoyale}">대전</span>
        <span class="breadcrumb-separator"th:if="${item.itemCategoryDto.card}">카드</span>
        <span class="breadcrumb-separator"th:if="${item.itemCategoryDto.boardGame}">보드게임</span>
        <span class="breadcrumb-separator"th:if="${item.itemCategoryDto.horror}">공포</span>
        <span class="breadcrumb-separator"th:if="${item.itemCategoryDto.platformer}">플랫포머</span>
        <span class="breadcrumb-separator"th:if="${item.itemCategoryDto.moba}">MOBA</span>
        <span class="breadcrumb-separator"th:if="${item.itemCategoryDto.mmorpg}">MMORPG</span>
        <span class="breadcrumb-separator">›</span>
        <span class="breadcrumb-current" th:text="${item.itemNm}"></span>
        <hr class="my-2">
    </div>

    <div class="d-flex">
        <div class="repImgDiv">
            <img th:src="${item.itemImgDtoList[0].imgUrl}" class="rounded repImg" th:alt="${item.itemNm}">
        </div>
        <div class="wd50">
            <span th:if="${item.stockNumber!=0}" class="sell mgb-15">판매중</span>
            <span th:if="${item.stockNumber==0}" class="soldout mgb-15">품절</span>
            <div class="h2" th:text="${item.itemNm}"></div>
            <div>
                별점:
                <span th:if="${item.avg == 0}">평점 없음</span>
                <span th:if="${item.avg > 0}">
                    <span th:text="${#numbers.formatDecimal(item.avg, 1, 1)}"></span>
                    <span th:each="i : ${#numbers.sequence(1, item.avg)}"><i class="fas fa-star"></i></span><!--
                 --><th:block th:unless="${item.avg==5}"><!--
                     --><span th:each="i : ${#numbers.sequence(item.avg + 1, 5)}"><i class="far fa-star"></i></span>
                    </th:block>
                </span>
                (<span th:text="${item.allReview}"></span>건)
            </div>
            <hr class="my-4">

            <!-- 가격 ---------------------------------------------------->
            <div class="h3 text-dark text-left">
                <div class="input-group ml-auto priceform">
                    <div class="firstPrice w-100">
                        <span th:text="${#numbers.formatInteger(item.price, 1,'COMMA')}"></span>원
                    </div>
                    <div class="input-group-prepend">
                        <span class="input-group-text">구매수량</span>
                    </div>
                    <input type="number" name="count" id="count" class="form-control" value="1" min="1">
                </div>
                <div class="totalPrice">
                    합계 : 
                    <span name="totalPrice" id="totalPrice" class="font-weight-bold"></span>
                </div>   
                <input type="hidden" th:value="${item.price}" id="price" name="price">                    
            </div>

            <hr class="my-4-4">
            <!-- 닌텐도 안내문 -->
            <div class="instructions" th:if="${item.company == 'nintendo'}">
                <h2>닌텐도 스위치에서 코드 입력 방법</h2>
                <ol>
                    <li><strong>홈 메뉴</strong>에서 <strong>"닌텐도 e샵"</strong>을 실행하세요.</li>
                    <li>사용하실 <strong>계정을 선택</strong>해 주세요.</li>
                    <li>화면 왼쪽에서 <strong>"Enter Code (코드 입력)"</strong>를 선택하세요.</li>
                    <li>총 16자의 다운로드 코드를 입력해 주세요.</li>
                    <li><strong>"확인"</strong>을 선택합니다.</li>
                </ol>
            </div>
            <!-- 스팀 안내문 -->
            <div class="instructions" th:if="${item.company == 'steam'}">
                <h2>스팀에서 코드 입력 방법</h2>
                <ol>
                    <li><strong>스팀 클라이언트</strong>에 접속하여 <strong>스팀에 로그인</strong>합니다.</li>
                    <li>스팀 클라이언트 <strong>왼쪽 하단</strong>에 있는 <strong>'게임 추가 - STEAM에 제품 등록'</strong>을 클릭합니다.
                    </li>
                    <li>제품 등록 약관에 동의한 후 메일에 적혀있는 <strong>게임 코드를 입력</strong>합니다.</li>
                </ol>
            </div>
            <!-- PS 안내문 -->
            <div class="instructions" th:if="${item.company == 'ps'}">
                <h2>PlayStation Store에서 코드 입력 방법</h2>
                <ol>
                    <li><strong>PlayStation Store</strong>로 이동하여 화면 상단의 <strong>프로필</strong>을 선택하세요.</li>
                    <li>드롭다운 메뉴에서 <strong>코드 번호 입력</strong>을 선택하세요.</li>
                    <li>16자리 코드를 정확하게 입력한 후 <strong>계속</strong>을 선택하세요.</li>
                    <li>그러면 크레딧 또는 콘텐츠가 계정에 적용됩니다.</li>
                </ol>
            </div>
            <!-- <p class="lead" th:text="${item.itemDetail}"></p> -->
            <span class="guide"> 구매 전 안내사항을 확인해 주세요.</span>
            <hr class="my-4-4">
        </div>
    </div>

    <!-- 버튼 시작 -장바구니, 주문하기, 찜, 품절 -->
    <div class="custombar">
        <div th:unless="${item.stockNumber==0}" class="text-right">
            <button type="button" class="btn btn-order" onclick="order()">주문하기</button>
            <button type="button" class="btn btn-custom" onclick="addCart()">장바구니</button>
            <button type="button" id="wish-button" class="btn wish-button" onclick="addDibs()">
                <span>🤍</span>
            </button>
        </div>
    </div>

    <div class="custombar">
        <div th:if="${item.stockNumber==0}" class="text-right">
            <button type="button" class="btn btn-soldout">품절된 게임 입니다.</button>
            <button type="button" id="wish-button" class="btn wish-button" onclick="addDibs()">
                <span>🤍</span>
            </button>
        </div>
    </div>

    <div class="sticky-nav">
        <div class="info-item">
            <a href="#purchase-info">안내사항</a>
        </div>
        <div class="info-item">
            <a href="#shipping-info">게임 내용</a>
        </div>
        <div class="info-item">
            <a href="#review-info">리뷰(<span th:text="${item.allReview}"></span>)</a>
        </div>
    </div>

    <div class="container-fluid" style="margin: auto;">
        
        <div id="purchase-info" class="jumbotron jumbotron-fluid mgt-30">
            <!-- <div><span class="dtlinfo">플랫폼:</span> <span th:text="${item.company}"></span></div>
            <div>
                <span class="dtlinfo">장르:</span>
                <span th:if="${item.itemCategoryDto.action}">액션</span>
                <span th:if="${item.itemCategoryDto.adventure}">모험</span>
                <span th:if="${item.itemCategoryDto.rpg}">RPG</span>
                <span th:if="${item.itemCategoryDto.shooter}">슈팅</span>
                <span th:if="${item.itemCategoryDto.strategy}">전략</span>
                <span th:if="${item.itemCategoryDto.simulation}">시뮬레이션</span>
                <span th:if="${item.itemCategoryDto.puzzle}">퍼즐</span>
                <span th:if="${item.itemCategoryDto.sports}">스포츠</span>
                <span th:if="${item.itemCategoryDto.racing}">레이싱</span>
                <span th:if="${item.itemCategoryDto.fighting}">격투</span>
                <span th:if="${item.itemCategoryDto.survival}">생존</span>
                <span th:if="${item.itemCategoryDto.rhythm}">리듬게임</span>
                <span th:if="${item.itemCategoryDto.sandbox}">샌드박스</span>
                <span th:if="${item.itemCategoryDto.battleRoyale}">대전</span>
                <span th:if="${item.itemCategoryDto.card}">카드</span>
                <span th:if="${item.itemCategoryDto.boardGame}">보드게임</span>
                <span th:if="${item.itemCategoryDto.horror}">공포</span>
                <span th:if="${item.itemCategoryDto.platformer}">플랫포머</span>
                <span th:if="${item.itemCategoryDto.moba}">MOBA</span>
                <span th:if="${item.itemCategoryDto.mmorpg}">MMORPG</span>
            </div> -->

            <div class="container">
                <h2 class="display-5">구매 전 안내사항</h2>
                <hr class="my-4">
                <div class="product-details">
                    <h3>구매 절차</h3>
                    <p>본 상품은 구매 완료 후, 고유 코드가 발급되며, <strong>"코드 전송"</strong> 버튼을 클릭하시면 회원님의 이메일로 발송됩니다.<br>
                        코드 전송 후에는 교환 및 환불이 불가하므로, 결제 및 코드 수령 과정에서 유의해주시기 바랍니다.</p>

                    <h3>교환 및 환불 정책</h3>
                    <p>결제 완료 후에는 발급된 코드가 회원님의 이메일로 발송되므로, <strong>교환 및 환불이 불가</strong>합니다.<br>
                        코드를 발송하기 전에는 결제 취소가 가능하지만, 발송 이후에는 불가능합니다.</p>

                    <h3>고객 주의 사항</h3>
                    <p>코드 전송 버튼을 클릭하기 전, 이메일 주소를 정확히 확인해주시기 바랍니다.<br>
                        오기입으로 인한 코드 미수령은 고객님 책임이므로 주의 바랍니다.<br>
                        상품 사용을 위한 고유 코드의 유효 기간은 <strong>[유효 기간 예시: 발급일로부터 30일]</strong>입니다.</p>

                    <h3>사용법 및 유의사항</h3>
                    <p>본 상품의 코드는 1회 사용만 가능하며, 타인에게 양도가 불가능합니다.<br>
                        코드 사용 시, 지정된 플랫폼 또는 애플리케이션에서만 유효합니다.</p>

                    <h3>고객 지원</h3>
                    <p>코드 발송 후 문의사항이나 도움이 필요하시면 <a href="[고객 지원 링크]">고객 지원</a>으로 문의해 주시기 바랍니다.</p>
                </div>
               
            </div>
        </div>

                <!--   이미지캐러셀  -->
                <div id="shipping-info">
                    <div id="carouselControls" class="carousel slide text-center" data-ride="carousel">
        
                        <div class="carousel-inner" data-interval="2200">
                            <div class="carousel-item active item">
                                <img th:src="${item.itemImgDtoList[0].imgUrl}" th:alt="${item.itemNm}" alt="First slide"
                                    class="d-block rounded">
                            </div>
                            <div class="carousel-item item">
                                <img th:src="${item.itemImgDtoList[1].imgUrl}" th:alt="${item.itemNm}" alt="Second slide"
                                    class="d-block rounded">
                            </div>
                            <div class="carousel-item item">
                                <img th:src="${item.itemImgDtoList[2].imgUrl}" th:alt="${item.itemNm}" alt="Third slide"
                                    class="d-block rounded">
                            </div>
                            <div class="carousel-item item">
                                <img th:src="${item.itemImgDtoList[3].imgUrl}" th:alt="${item.itemNm}" alt="Fourth slide"
                                    class="d-block rounded">
                            </div>
                        </div>
        
        
                        <ul class="carousel-indicators">
                            <li data-target="#carouselControls" data-slide-to="0" class="active"></li>
                            <li data-target="#carouselControls" data-slide-to="1"></li>
                            <li data-target="#carouselControls" data-slide-to="2"></li>
                            <li data-target="#carouselControls" data-slide-to="3"></li>
                        </ul>
        
                        <a class="carousel-control-prev" href="#carouselControls" data-slide="prev">
                            <i class="fa-solid fa-chevron-left"></i>
                        </a>
                        <a class="carousel-control-next" href="#carouselControls" data-slide="next">
                            <i class="fa-solid fa-chevron-right"></i>
                        </a>
        
        
                    </div>
                </div>
                <!--   이미지캐러셀 end-->

        <!-- 이미지 나열 -->
         
        <div th:each="itemImg : ${item.itemImgDtoList}" class="text-center">
            <img th:if="${not #strings.isEmpty(itemImg.imgUrl)}" th:src="${itemImg.imgUrl}"
                class="rounded mgb-15 responsive-img">
        </div>

        <hr class="my-4-2" id="review-info">
        <!-- 별점 평점 + 리뷰수 -->
        <div class="rating-value">
            <div class="rating-count">총<span th:text="${item.allReview}"></span>건</div>
            <span th:if="${item.avg == 0}">평점 없음</span>
            <span th:if="${item.avg > 0}">
                <div>
                    <span th:text="${#numbers.formatDecimal(item.avg, 1, 1)}"></span>점
                </div>
                <span th:each="i : ${#numbers.sequence(1, item.avg)}"><i class="fas fa-star"></i> </span>
                <th:block th:unless="${item.avg==5}">
                    <span th:each="i : ${#numbers.sequence(item.avg + 1, 5)}"><i class="far fa-star"></i> </span>
                </th:block>
            </span>
        </div>

        <!-- 리뷰 등록 버튼 -->
        <button type="button" class="btn btn-info addReviewBtn">게임 평가하기</button>

        <!-- 리뷰 별점 높은순 버튼 -->
        <div class="dropdown" style="float: right; margin-right: 20px;">
            <button class="btn btn-sm btn-link text-dark toggle" style="height: 20px;" type="button"
                id="sortDropdownButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <span id="currentSortMethod">최신순</span> <!-- 초기 표시값 설정 -->
                <i class="fa-solid fa-lines-leaning"></i>
            </button>
            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="sortDropdownButton">
                <button class="dropdown-item rating">별점 높은 순</button>
                <button class="dropdown-item asc">별점 낮은 순</button>
                <button class="dropdown-item recommendation">추천순</button>
                <button class="dropdown-item latest">최신순</button>
            </div>
        </div>


        <!-- 리뷰 목록 -->
        <div class="list-group reviewList"></div>

        <!-- 리뷰 목록을 표시할 때 추천(따봉) 카운트와 버튼 추가 -->
        <div th:each="review : ${reviewList}" class="review-item card card border-0 shadow-none p-3 mb-3"
            data-reviewnum="${review.reviewnum}" data-mid="${review.email}">

            <div class="d-flex align-items-center">
                <!-- 프로필 아이콘 -->
                <div class="profile-icon bg-secondary rounded-circle text-white d-flex align-items-center justify-content-center"
                    style="width: 40px; height: 40px;">
                    <span th:text="${review.email.substring(0, 1).toUpperCase()}"></span>
                </div>
                <div class="ml-3">
                    <h6 class="card-subtitle mb-1 text-muted" th:text="${review.email}"></h6>
                    <p class="card-text small" th:text="${#dates.format(review.regTime, 'yyyy-MM-dd HH:mm:ss')}"></p>
                    <div class="reviewgrade" data-grade="${review.grade}"></div>
                    
                </div>
                <!-- 옵션 버튼 -->
                <div class="dropdown">
                    <button class="btn btn-sm btn-link text-dark toggle" type="button" id="dropdownMenuButton"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton">
                        <button class="dropdown-item modalBtn" type="button">수정</button>
                        <button class="dropdown-item removeBtn" type="button">삭제</button>
                    </div>
                </div>
            </div>



            <div class="mt-2">
                <!-- <div class="reviewgrade" data-grade="${review.grade}"></div> -->
                <h6 class="card-title mt-2" th:text="${review.text}"></h6>
            </div>

            <!-- 추천 수 표시 및 추천 버튼 -->
            <div class="recommend-section d-flex align-items-center mt-3">
                <span class="rCnt mr-2">${review.rcnt != null ? review.rcnt : 0}</span><span class="rCnt mr-3">명이 유용하다고 답한 리뷰입니다.</span>
            </div>
            <div>
                <span class="rCnt mr-3">리뷰가 도움이 되었나요?</span>
                <button class="btn btn-sm ${review.recommended ? 'btn-primary' : 'btn-outline-primary'} recommendBtn"
                    data-reviewnum="${review.reviewnum}">
                    <i class="${review.recommended ? 'fas fa-solid' : 'far fa-regular'} fa-thumbs-up"></i>
                </button>
            </div>

        </div>

        <!-- 페이지 네비게이션 -->
        <div class="pagination">
            <button class="page-btn prevPage">&lt;</button> <!-- 이전 페이지 버튼 -->
            <div id="pageNumbers" class="page-numbers"></div> <!-- 동적 페이지 버튼 -->
            <button class="page-btn nextPage">&gt;</button> <!-- 다음 페이지 버튼 -->
        </div>

        <!-- 로그인 여부에 따라 hidden 필드에 값 설정 -->
        <input type="hidden" id="isLoggedIn" th:value="${email != null ? 'true' : 'false'}">
        <input type="hidden" id="isLoginCheck" th:value="${email}">

        <!-- 리뷰 모달 -->
        <div class="reviewModal modal" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="review-current" th:text="${item.itemNm}"></h5>
                        <button type="button" class="close closeBtn" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">                            
                            <input type="hidden" class="form-control" name="email" th:value="${email}" readonly>
                        </div>
                        <div class="form-group" id="divGrade">
                            <div>
                            <label><h5 class="reviewment">이 게임은 어떠셨나요?</h5><span class="grade"></span></label>
                            </div>
                            <div class='starrr reviewmodalstarrr'></div>
                        </div>
                        <div class="form-group">
                            <div class="form-group" id="label-container">
                                <label>어떤 점이 좋았나요?</label>
                            </div>
                            <textarea class="form-control" name="text" placeholder="여기에 게임을 평가해주세요!" rows="4" maxlength="5000"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary closeBtn closeModal" data-dismiss="modal">닫기</button>
                        <button type="button" class="btn btn-secondary reviewSaveBtn saveModal">등록</button>
                        <button type="button" class="btn btn-warning modifyBtn">확인</button>
                        <!-- <button  class="btn btn-danger removeBtn modalRemove">Remove</button> -->
                    </div>
                </div>
            </div>
        </div>


        <div class="imageModal modal " tabindex="-2" role="dialog">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Picture</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body"></div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 사용자 스크립트 추가 -->
    <script th:src="@{/starrr.js}"></script>
    <link th:href="@{/css/starrr.css}" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.2.0/css/font-awesome.min.css">
    <!-- 사용자 스크립트 추가 -->
    <th:block layout:fragment="script">
        <script th:inline="javascript">
            $(document).ready(function () {

                calculateToalPrice();

                $("#count").change(function () {
                    calculateToalPrice();
                });

                //찜하기 버튼 로직
                const dibs = [[${ callDibs }]]; // 또는 false로 변경 가능
                const wishBtn = $("#wish-button");
                if (dibs) {
                    $("#wish-button span").text("❤");
                } else {
                    $("#wish-button span").text("🤍");
                }
                // 버튼 클릭 시 토글 기능
                wishBtn.on("click", function () {
                    $(this).toggleClass("active");
                });

                var grade = 0;
                var grade2 = 0; // grade2 변수 초기화
                var id = [[${ item.id }]];
                var reviewnum;

                // 리뷰 모달 관련 변수 정의
                var reviewModal = $(".reviewModal");
                var inputMid = $('input[name="email"]');
                var inputText = $('textarea[name="text"]');

                //리뷰 정렬 변수 정의
                let currentPage = 0;
                let currentSort = "regTime";

                $.ajaxSetup({
                    headers: {
                        'X-CSRF-TOKEN': $('meta[name="_csrf"]').attr('content')
                    }
                });

                // 리뷰 목록 로드 함수
                function loadReviews(page, sort = "regTime") {
                    currentSort = sort;
                    const itemId = $("#itemId").val();
                    const loggedInEmail = $('#isLoginCheck').val(); // 로그인한 사용자의 이메일

                    $.ajax({
                        url: `/reviews/${itemId}/all?page=${page}&sort=${sort}`,
                        type: "GET",
                        dataType: "json",
                        success: function (data) {
                            let reviewHtml = "";

                            data.content.forEach(function (review) {
                                let dropdownHtml = '';
                                if (review.email === loggedInEmail) {
                                    dropdownHtml = `
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-link text-dark dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton">
                                                <button class="dropdown-item modalBtn" type="button">수정</button>
                                                <button class="dropdown-item removeBtn" type="button">삭제</button>
                                            </div>
                                        </div>`;
                                }

                                reviewHtml += `
                                    <div class="review-item card p-3 mb-3" data-reviewnum="${review.reviewnum}" data-mid="${review.email}">
                                        <div class="d-flex align-items-center">
                                            <img src="/icon/icon_${review.profileImg}.svg" class="user-image" style="width: 60px; height: 60px;"/>    
                                            <div class="ml-3 mr-3">
                                                <h6 class="card-subtitle mb-1 text-muted">${review.email}</h6>
                                                <p class="card-text small">${new Date(review.regTime).toLocaleString()}</p>
                                            </div>
                                            ${dropdownHtml}
                                        </div>
                                    
                                        <div class="mt-2">
                                            <div class="reviewgrade" data-grade2="${review.grade}"></div>
                                            <h6 class="card-title mt-2">${review.text}</h6>
                                        </div>
                                        <div class="recommend-section d-flex align-items-center mt-3">
                                            <span class="rCnt mr-2">${review.rcnt != null ? review.rcnt : 0}</span><span class="rCnt mr-3">명이 유용하다고 답한 리뷰입니다.</span>
                                            </div>
                                            <div>
                                            <span class="rCnt mr-3">이 리뷰가 도움이 되었나요?</span>
                                            <button class="btn btn-sm ${review.recommended ? 'btn-primary' : 'btn-outline-primary'} recommendBtn" data-reviewnum="${review.reviewnum}">
                                                <i class="${review.recommended ? 'fas fa-solid' : 'far fa-regular'} fa-thumbs-up"></i>
                                            </button>
                                        </div>
                                    </div>
                                `;
                            });

                            $(".reviewList").html(reviewHtml);
                            renderStars(); // 리뷰별점 표시
                            currentPage = data.number;
                            totalPages = data.totalPages;
                            updatePagination(); // 페이지네이션 업데이트
                        },
                        error: function (xhr) {
                            console.error("Error: " + xhr.responseText);
                        }
                    });
                }

                loadReviews(0);

                // 별점 표시 함수
                function renderStars() {
                    $(".reviewgrade").each(function () {
                        $(this).starrr({
                            rating: $(this).data("grade2"),
                            readOnly: true
                        });
                        //a 비활성화
                        $(this).find('a').css('pointer-events', 'none');

                        // 채워진 별과 빈 별 스타일 적용
                        $(this).find(".fa-star").css("color", "#FFD700");  // 채워진 별 노란색
                        $(this).find(".fa-star-o").css("color", "#d3d3d3"); // 빈 별 회색
                    });
                }

                // 페이지네이션 버튼 업데이트 함수
                function updatePagination() {
                    const pageNumbers = $("#pageNumbers");
                    pageNumbers.empty(); // 기존 버튼 제거

                    for (let i = 0; i < totalPages; i++) {
                        const pageButton = $('<button class="page-btn page-number"></button>').text(i + 1);
                        if (i === currentPage) {
                            pageButton.addClass('active');
                        }
                        pageButton.click(function () {
                            loadReviews(i, currentSort);
                        });
                        pageNumbers.append(pageButton);
                    }
                }

                // 이전 페이지 버튼 클릭 이벤트
                $(".prevPage").click(function () {
                    if (currentPage > 0) {
                        loadReviews(currentPage - 1, currentSort);
                    }
                });

                // 다음 페이지 버튼 클릭 이벤트
                $(".nextPage").click(function () {
                    if (currentPage < totalPages - 1) {
                        loadReviews(currentPage + 1, currentSort);
                    }
                });


                // 추천 버튼 클릭 이벤트
                $(".reviewList").on("click", ".recommendBtn", function (e) {
                    e.stopPropagation();
                    const reviewnum = $(this).data("reviewnum");
                    const email = $("#isLoginCheck").val();

                    if ($("#isLoggedIn").val() === "false") {
                        alert("로그인이 필요합니다. 로그인 페이지로 이동합니다.");
                        window.location.href = "/members/login";
                    } else {
                        $.ajax({
                            url: `/reviews/${reviewnum}/recommend`,
                            type: "POST",
                            data: { email: email },
                            success: function (response) {
                                const icon = $(this).find('i');
                                if (response == "추천 완료") {
                                    icon.removeClass('far fa-regular').addClass('fas fa-solid');
                                } else {
                                    icon.removeClass('fas fa-solid').addClass('far fa-regular');
                                }
                                loadReviews(currentPage, currentSort); // 추천 상태 변경 후 리뷰 목록 다시 로드
                            },
                            error: function (xhr) {
                                console.error("Error: " + xhr.responseText);
                            }
                        });
                    }
                });

                // 정렬 버튼 클릭 시 이벤트
                $('.dropdown-item').click(function () {
                    var selectedSortMethod = $(this).text();
                    $('#currentSortMethod').text(selectedSortMethod); // 선택된 정렬 방식 표시 업데이트
                    const sortType = $(this).attr('class').split(' ')[1];
                    loadReviews(0, sortType); // 첫 페이지부터 새로운 정렬 방식으로 로드
                });

                //닫기버튼
                $('.closeBtn').click(function () {
                    $(this).closest('.modal').modal('hide');
                });

                // 리뷰 등록 버튼 클릭
                $(".addReviewBtn").click(function () {
                    var isLoggedIn = $("#isLoggedIn").val();
                    if (isLoggedIn === "false") {
                        alert("로그인이 필요합니다. 로그인 페이지로 이동합니다.");
                        window.location.href = "/members/login";
                        return;
                    }
                    $.ajax({
                        url: `/reviews/validRegist`,
                        type: "POST",
                        data: { itemId: $("#itemId").val()},
                        success: function (response) {
                            if (response == "valid") {
                                grade = 0;
                                inputText.val("");
                                var star = $(".starrr").clone();
                                $(".starrr").remove();
                                $("#divGrade").append(star);
                                $('.starrr').starrr({
                                    rating: grade,
                                    change: function (e, value) {
                                        if (value) grade = value;
                                    }
                                });
                                $(".removeBtn, .modifyBtn").hide();
                                $(".reviewSaveBtn").show();
                                reviewModal.modal('show');
                            } else if(response=="invalid") {
                                alert("게임을 구매한 사람만 리뷰등록이 가능합니다");
                            } else {
                                alert("리뷰작성은 게임 하나당 한번씩 가능합니다");
                            }
                        },
                        error: function (xhr) {
                            console.error("Error: " + xhr.responseText);
                        }
                    });



                });

                // 리뷰 저장 버튼
                $('.reviewSaveBtn').click(function () {
                    if(grade==0){
                        alert("별을 눌러 평점을 매겨주세요");
                        return;
                    }
                    var data = { id: id, grade: grade, text: inputText.val(), email: inputMid.val() };
                    $.ajax({
                        url: '/reviews/' + id,
                        type: "POST",
                        data: JSON.stringify(data),
                        contentType: "application/json; charset=utf-8",
                        dataType: "text",
                        success: function () {
                            self.location.reload();
                        },
                        error: function (xhr, status, error) {
                            console.error("Error: " + xhr.responseText); // 오류 디버깅
                        }
                    });
                    reviewModal.modal('hide');
                });

                $(".reviewList").on("click", ".modalBtn", function (e) {
                    e.stopPropagation(); // 이벤트 전파 방지

                    var isLoginCheck = $("#isLoginCheck").val();
                    var targetReview = $(this).closest(".review-item");
                    var reviewEmail = targetReview.data("mid");

                    // 로그인 사용자와 리뷰 작성자 일치 여부 확인
                    if (isLoginCheck === reviewEmail) {
                        $(".reviewSaveBtn").hide();
                        $(".removeBtn, .modifyBtn").show();
                        reviewModal.modal('show');
                    } else {
                        alert("본인의 리뷰만 수정할 수 있습니다.");
                        return;
                    }

                    // 선택한 리뷰의 데이터 불러오기
                    reviewnum = targetReview.data("reviewnum");
                    inputMid.val(targetReview.data("mid"));
                    inputText.val(targetReview.find('.card-title').text().trim());
                    grade2 = targetReview.find(".reviewgrade").data("grade2");

                    // 별점 초기화
                    var star = $(".starrr").clone();
                    $(".starrr").remove();
                    $("#divGrade").append(star);

                    $(".starrr").starrr({
                        rating: grade2,
                        change: function (e, value) {
                            if (value) grade2 = value;
                        }
                    });
                });

                // 리뷰 수정 버튼
                $(".modifyBtn").on("click", function () {
                    var data = { reviewnum: reviewnum, id: id, grade: grade2, text: inputText.val(), email: inputMid.val() };
                    $.ajax({
                        url: '/reviews/' + id + "/" + reviewnum,
                        type: "PUT",
                        data: JSON.stringify(data),
                        contentType: "application/json; charset=utf-8",
                        dataType: "text",
                        success: function () {
                            self.location.reload();
                        }
                    });
                    reviewModal.modal('hide');
                });

                // 리뷰 삭제 버튼
                $('.reviewList').on('click', '.removeBtn', function () {
                    var targetReview = $(this).closest(".review-item");
                    var reviewnum = targetReview.data("reviewnum");
                    var id = $("#itemId").val(); // id 변수를 확실하게 설정

                    $.ajax({
                        url: '/reviews/' + id + "/" + reviewnum,
                        type: "DELETE",
                        contentType: "application/json; charset=utf-8",
                        dataType: "text",
                        success: function () {
                            alert('리뷰가 삭제되었습니다.'); // 사용자에게 피드백 제공
                            targetReview.remove(); // 페이지 리로드 없이 리뷰 항목 제거
                        },
                        error: function (xhr, status, error) {
                            console.error("Error: " + xhr.responseText); // 오류 디버깅 정보 표시
                            alert('리뷰 삭제 실패: ' + xhr.responseText); // 사용자에게 오류 메시지 표시
                        }
                    });
                });

            });

            function calculateToalPrice() {
                var count = $("#count").val();
                var price = $("#price").val();
                var totalPrice = price * count;
                 // 천 단위로 쉼표를 추가하여 포맷
                var formattedTotalPrice = totalPrice.toLocaleString();

                // 포맷된 가격 표시
                $("#totalPrice").html(formattedTotalPrice + '원');
            }

            function order() {
                var token = $("meta[name='_csrf']").attr("content");
                var header = $("meta[name='_csrf_header']").attr("content");

                var paramData = {
                    itemId: $("#itemId").val(),
                    count: $("#count").val()
                };

                var param = JSON.stringify(paramData);

                $.ajax({
                    url: "/itemDetailToOrder",
                    type: "POST",
                    data: {itemId:$("#itemId").val(), count:$("#count").val()},
                    beforeSend: function (xhr) {
                        /* 데이터를 전송하기 전에 헤더에 csrf값을 설정 */
                        xhr.setRequestHeader(header, token);
                    },
                    dataType: "Text",
                    cache: false,
                    success: function (result) {
                        if (result == 0) {
                            alert("죄송합니다. 수량이 부족합니다.");
                            return;
                        }
                        $.ajax({
                            url: "/order",
                            type: "POST",
                            contentType: "application/json",
                            data: param,
                            beforeSend: function (xhr) {
                                /* 데이터를 전송하기 전에 헤더에 csrf값을 설정 */
                                xhr.setRequestHeader(header, token);
                            },
                            dataType: "json",
                            cache: false,
                            success: function (result, status) {
                                location.href = '/order/payment?orderId=' + result;
                            },
                            error: function (jqXHR, status, error) {
                                alert('로그인 후 이용해주세요');
                                location.href = '/members/login';
                            }
                        });

                    },
                    error: function (jqXHR, status, error) {
                        alert('로그인 후 이용해주세요');
                        location.href = '/members/login';
                    }
                });
            }

            function addCart() {
                var token = $("meta[name='_csrf']").attr("content");
                var header = $("meta[name='_csrf_header']").attr("content");

                var url = "/cart";
                var paramData = {
                    itemId: $("#itemId").val(),
                    count: $("#count").val()
                };

                var param = JSON.stringify(paramData);

                $.ajax({
                    url: url,
                    type: "POST",
                    contentType: "application/json",
                    data: param,
                    beforeSend: function (xhr) {
                        /* 데이터를 전송하기 전에 헤더에 csrf값을 설정 */
                        xhr.setRequestHeader(header, token);
                    },
                    dataType: "json",
                    cache: false,
                    success: function (result, status) {
                        if (result == 0) {
                            alert("죄송합니다. 수량이 부족합니다.");
                            return;
                        }
                        alert("상품을 장바구니에 담았습니다.");
                        cartCount();
                        if (confirm("장바구니로 이동하시겠습니까?")) {
                            location.href = "/cart";
                        }
                    },
                    error: function (jqXHR, status, error) {
                        alert('로그인 후 이용해주세요');
                        location.href = '/members/login';
                    }
                });
            }

            function addDibs() {
                var token = $("meta[name='_csrf']").attr("content");
                var header = $("meta[name='_csrf_header']").attr("content");

                var url = "/dibsAdd";
                var type = "POST";
                var paramData = {
                    itemId: $("#itemId").val()
                };

                if ($("#wish-button").hasClass("active")) {
                    url = "/dibsDelete";
                    type = "DELETE";
                }

                var param = JSON.stringify(paramData);
                $.ajax({
                    url: url,
                    type: type,
                    contentType: "application/json",
                    data: param,
                    beforeSend: function (xhr) {
                        /* 데이터를 전송하기 전에 헤더에 csrf값을 설정 */
                        xhr.setRequestHeader(header, token);
                    },
                    dataType: "json",
                    cache: false,
                    success: function (result) {
                        dibsCount();

                        // 텍스트 변경
                        if ($("#wish-button").hasClass("active")) {
                            $("#wish-button span").text("❤");
                        } else {
                            $("#wish-button span").text("🤍");
                        }
                    },
                    error: function (jqXHR, status, error) {
                        alert('로그인 후 이용해주세요');
                        location.href = '/members/login';
                    }
                });
            }
        </script>
    </th:block>
</div>


</html>