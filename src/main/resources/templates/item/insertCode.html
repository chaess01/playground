<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}"
      class="insertCode">

<head>
  <link th:href="@{/css/shop.css}" rel="stylesheet">
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>


<div layout:fragment="content">
  <!-- ìƒë‹¨ ì œëª©ê³¼ ê²Œì„ ì•„ì´ì½˜ -->
  <h2><span class="emoji">ğŸ®</span> ìƒí’ˆ ì¬ê³  ì½”ë“œ ì…ë ¥ <span class="emoji">ğŸ®</span></h2>

  <!-- ê²Œì„ ì •ë³´ -->
  <div class="game-info">
    <p><strong>ê²Œì„ ID:</strong> <span id="itemId" th:text="${itemId}"></span></p>
    <p><strong>ê²Œì„ ì´ë¦„:</strong> <span th:text="${itemNm}"></span></p>
  </div>

  <div>
    <!-- ì½”ë“œ ë“±ë¡ ì˜µì…˜ ì„ íƒ -->
    <div class="how-input">
      <p><strong>ì½”ë“œ ì…ë ¥ ë°©ì‹:</strong></p>
      <label><input type="radio" name="option" value="exist" checked> ìˆìŒ</label>
      <label><input type="radio" name="option" value="none"> ì—†ìŒ</label><br/>
    </div>

    <!-- ì½”ë“œ ì…ë ¥ í•„ë“œ -->
    <div id="inputDiv">
      <label class="code">1: <span class="error"></span><input class="form-control insert"></label>
      <label class="code">2: <span class="error"></span><input class="form-control insert"></label>
      <label class="code">3: <span class="error"></span><input class="form-control insert"></label>
      <label class="code">4: <span class="error"></span><input class="form-control insert"></label>
      <label class="code">5: <span class="error"></span><input class="form-control insert"></label>
    </div>

    <!-- ë²„íŠ¼ë“¤ -->
    <button class="btn btn-info addInput">â• ì…ë ¥ì¹¸ ì¶”ê°€</button>
    <button class="btn btn-success regCodes">âœ”ï¸ ì½”ë“œ ë“±ë¡</button>
    <button class="btn btn-warning fillCodes">ğŸ”„ ì½”ë“œ ìë™ ì±„ìš°ê¸°</button>
  </div>

</div>

<!-- ì‚¬ìš©ì ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€ -->
<th:block layout:fragment="script">
  <script th:inline="javascript">
    $(document).ready(function(){
      var inputNum=6;
      var token = $("meta[name='_csrf']").attr("content");
      var header = $("meta[name='_csrf_header']").attr("content");

      // 16ìë¦¬ ëœë¤ ì½”ë“œ ìƒì„± í•¨ìˆ˜
      function generateRandomCode() {
        const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
        let code = "";
        while (code.length < 16) {
          code += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return code.match(/.{4}/g).join("-"); // 4ìë¦¬ë§ˆë‹¤ '-' ì‚½ì…
      }

      // ì½”ë“œ ìë™ ì±„ìš°ê¸° ê¸°ëŠ¥
      $(".fillCodes").on('click', function() {
        const codes = new Set();
        $(".insert").each(function() {
          let randomCode;
          do {
            randomCode = generateRandomCode();
          } while (codes.has(randomCode)); // ì¤‘ë³µ ë°©ì§€
          codes.add(randomCode);
          $(this).val(randomCode);
          $(this).siblings('.error').hide();
        });
      });


      //ì…ë ¥ì¹¸ ì¶”ê°€
      $(".addInput").on('click',function(){
        for(var i=inputNum; i<inputNum+5; i++){
          var input1='<label class="code">'+i+': <span class="error"></span><input class="form-control insert"></label>';
          $("#inputDiv").append(input1);
        }
        inputNum+=5;
      });

      //ì½”ë“œ ë“±ë¡
      $(".regCodes").on('click', function() {
        var codes = [];
        const dashRegex = /^[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}$/;
        const regex = /^[A-Z0-9]{16}$/;
        var valid=true;

        $(".insert").each(function(idx) {
          var value = $(this).val();
          var errorMessage = $(this).siblings('.error');
          if (value) {
            if($('input[name="option"]:checked').val()=="exist"){
              if(dashRegex.test(value)){
                codes.push(value);
                errorMessage.hide();
              } else {
                errorMessage.text("ì½”ë“œ í˜•ì‹ ë¶ˆì¼ì¹˜").show();
                valid=false;
              }
            } else {
              if(regex.test(value)){
                codes.push(value.replace(/(.{4})/g, '$1-').slice(0, -1));
                errorMessage.hide();
              } else {
                errorMessage.text("ì½”ë“œ í˜•ì‹ ë¶ˆì¼ì¹˜").show();
                valid=false;
              }
            }
          }
        });
        if(!valid){
          alert("ì½”ë“œ ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
          return;
        }
        if (codes.length === 0) {
          alert("ì…ë ¥ê°’ì´ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        // JSON í˜•íƒœë¡œ ë³€í™˜
        var jsonData = JSON.stringify(codes);

        $.ajax({
          url: '/admin/insert/'+$("#itemId").text(),
          type: 'POST',
          contentType: 'application/json',
          data: jsonData,
          dataType:"text",
          beforeSend : function(xhr){
            xhr.setRequestHeader(header, token);
          },
          success: function(result) {
            $(".insert").val("");
            alert(result+"ê°œì˜ ì½”ë“œë¥¼ ë“±ë¡í•˜ì˜€ìŠµë‹ˆë‹¤");
          },
          error: function(xhr, status, error) {
            console.error("ì—ëŸ¬:", error);
          }
        });
      });

      //ì…ë ¥ì¹¸ ì œí•œ
      $("#inputDiv").on("input", ".insert",function() {
        var num = 19;
        if ($('input[name="option"]:checked').val() == "none") {
          num = 16;
        }
        var errorMessage = $(this).siblings('.error');

        if ($(this).val().length > num) {
          $(this).val($(this).val().substring(0, num));
          errorMessage.text("ì…ë ¥ê°’ ì´ˆê³¼").show();
        } else {
          errorMessage.hide();
        }
      });

      // ì˜µì…˜ ë³€ê²½ ì‹œ ê° ìš”ì†Œ ì²´í¬
      $('input[name="option"]').on('change', function() {
        var checked=false;
        $('.insert').each(function() {
          var inputValue = $(this).val();
          var errorMessage = $(this).siblings('.error');

          if (inputValue.length > 16) {
            $(this).val(inputValue.substring(0, 16));
            errorMessage.text("ì…ë ¥ê°’ ì´ˆê³¼").show();
            checked=true;
          } else {
            errorMessage.hide();
          }
        });
        if(checked){
          alert("ì…ë ¥ê°’ì´ ì´ˆê³¼ëœ í•­ëª©ì´ ìˆìŠµë‹ˆë‹¤.");
        }
      });

    })
  </script>
</th:block>

</html>