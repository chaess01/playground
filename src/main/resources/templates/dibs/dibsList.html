<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}"
      class="dibsList">

<head>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <link th:href="@{/css/dibsList.css}" rel="stylesheet">

</head>

<div layout:fragment="content" class="content-mg">

    <h2 class="mb-4">
        ì°œí•œ ëª©ë¡
    </h2>
    <table class="table">
        <thead>
            <tr class="text-center">
                <td class="subtitle">ìƒí’ˆ</td>
            </tr>
        </thead>
        <tbody class="dibsLists">
            <th:block th:unless="${dibsItems.size() == 0}">
                <tr th:each="dibsItem : ${dibsItems}">
                    <td class="d-flex dibsItem">
                        <div class="repImgDiv align-self-center">
                            <a th:href="'/item/' +${dibsItem.itemId}">
                                <!-- í’ˆì ˆ ìƒíƒœì— ë”°ë¼ ì´ë¯¸ì§€ì— í•„í„° ì¶”ê°€ ë° í’ˆì ˆ ë°°ì§€ í‘œì‹œ -->
                                <img th:src="${dibsItem.imgUrl}" class="rounded repImg" th:alt="${dibsItem.itemNm}"
                                     th:classappend="${dibsItem.stockNumber<=0 ? 'sold-out-filter' : ''}">
                                <!-- í’ˆì ˆ ìƒíƒœì¼ ê²½ìš° ë°°ì§€ í‘œì‹œ -->
                                <span th:if="${dibsItem.stockNumber<=0}" class="sold-out-badge">Sold Out</span>

                            </a>
                        </div>
                        <div class="align-self-center">
                            <a th:href="'/item/' +${dibsItem.itemId}">
                                <span th:text="${dibsItem.itemNm}" class="itnm fs24 font-weight-bold"></span>
                                
                            </a>
                            <div class="fs18 font-weight-light">
                                <span class="input-group mt-2">
                                    <span th:id="'price_' + ${dibsItem.dibsItemId}"
                                          th:data-price="${dibsItem.price}"
                                          th:text="${#numbers.formatInteger(dibsItem.price, 1,'COMMA')} + 'ì›'" class="align-self-center mr-2">

                                    </span>
                                    <button type="button" class="close" aria-label="Close">                             </button>
                                </span>
                            </div>
                        </div>
                        <div class="button-container ml-auto align-self-center">
                            <!-- í’ˆì ˆë˜ì§€ ì•Šì€ ê²½ìš° ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€í•  ìˆ˜ ìˆë„ë¡ ì²˜ë¦¬ -->
                            <button th:if="${dibsItem.stockNumber<=0}" class="fs16 text-muted custom-btn">í’ˆì ˆ</button>
                            <button th:if="${dibsItem.stockNumber>0}" class="addCart custom-btn" th:data-id="${dibsItem.dibsItemId}" onclick="addCartFromDibs(this)">ğŸ›’</button>
                            <button aria-hidden="true" th:data-id="${dibsItem.dibsItemId}" onclick="deleteDibsItem(this)" class="deleteBtn custom-btn">â¤</button>
                            
                        </div>
                    </td>
                </tr>
            </th:block>
            <th:block th:if="${dibsItems.size() == 0}">
                <tr><td class="d-flex"><h4>ê²°ê³¼ ì—†ìŒ</h4></td></tr>
            </th:block>
        </tbody>
    </table>
</div>


<!-- ì‚¬ìš©ì ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€ -->
<th:block layout:fragment="script">

    <script th:inline="javascript">
        function addCartFromDibs(obj){
            var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");
            var dibsItemId=$(obj).data('id');

            var paramData = {
                dibsItemId: dibsItemId
            };
            var param = JSON.stringify(paramData);

            $.ajax({
                url: "/dibsToCart",
                type: "POST",
                data: {dibsItemId: dibsItemId},
                beforeSend: function (xhr) {
                    xhr.setRequestHeader(header, token);
                },
                cache: false,
                success: function (result, status) {
                    if(result==0){
                        alert("ì¬ê³ ê°€ ì—†ìŠµë‹ˆë‹¤.");
                        return;
                    }
                    alert("ìƒí’ˆì„ ì¥ë°”êµ¬ë‹ˆì— ë‹´ì•˜ìŠµë‹ˆë‹¤.");
                    if(confirm("ì¥ë°”êµ¬ë‹ˆë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){
                        location.href="/cart";
                    } else{
                        location.reload();
                    }
                },
                error: function (jqXHR, status, error) {
                    alert('ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”');
                }
            });

        }

        function deleteDibsItem(obj){
            var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");

            var paramData = {
                dibsItemId: $(obj).data('id')
            };

            var param = JSON.stringify(paramData);

            $.ajax({
                url      : "/dibsDelete",
                type     : "DELETE",
                contentType: "application/json",
                data: param,
                beforeSend : function(xhr){
                    xhr.setRequestHeader(header, token);
                },
                dataType : "json",
                cache   : false,
                success  : function(result){
                    location.reload();
                },
                error : function(jqXHR, status, error){
                    alert('ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”');
                }
            });
        }


    </script>

</th:block>

</html>